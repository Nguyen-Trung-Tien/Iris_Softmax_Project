<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iris MLOps Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <header style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1><i class="fas fa-cubes"></i> Iris MLOps Platform</h1>
            <p>Enterprise AI Management: Train, Predict, Monitor, Explain</p>
        </div>
        <nav>
            <a href="/dashboard" class="nav-link"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a href="/about" class="nav-link"><i class="fas fa-book"></i> Docs</a>
        </nav>
    </header>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" data-target="dashboard">
            <i class="fas fa-tachometer-alt"></i> Home
        </button>
        <button class="tab-btn" data-target="models">
            <i class="fas fa-code-branch"></i> Versioning
        </button>
        <button class="tab-btn" data-target="insights">
            <i class="fas fa-lightbulb"></i> Insights (XAI & Drift)
        </button>
        <button class="tab-btn" data-target="lab">
            <i class="fas fa-flask"></i> Training Lab
        </button>
    </div>

    <!-- 1. DASHBOARD TAB (Prediction & Training) -->
    <div id="dashboard" class="tab-pane active">
        <div class="grid-layout">
            
            <!-- TRAINING CARD -->
            <div class="card training-card">
                <h3><i class="fas fa-brain"></i> Model Training (Production)</h3>
                <p>Train the Stochastic Gradient Descent (SGD) model on the full dataset for production deployment.</p>
                
                <details style="margin-bottom: 1rem; color: var(--gray); font-size: 0.9rem;">
                    <summary style="cursor: pointer; font-weight: 500;">Feature Details</summary>
                    <p style="margin-top: 0.5rem; text-align: justify;">
                        The <strong>Model Training</strong> module creates the production-ready classification model. 
                        It utilizes Stochastic Gradient Descent (SGD) for efficient learning. The process includes data normalization (StandardScaler) and label encoding.
                        Upon completion, the model is versioned, metrics are logged to the Training History, and the system automatically swaps to the new model for live inference.
                    </p>
                </details>

                <div style="margin-bottom: 1rem;">
                    <label for="testSize" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-dark);">
                        Data Split: 
                        <span style="color: var(--primary);">Train <span id="trainPct">80</span>%</span> / 
                        <span style="color: #ec4899;">Test <span id="testPct">20</span>%</span>
                    </label>
                    <input type="range" id="testSize" min="0.1" max="0.5" step="0.05" value="0.2" style="width: 100%;" 
                           oninput="
                             const val = parseFloat(this.value); 
                             document.getElementById('testPct').innerText = Math.round(val * 100);
                             document.getElementById('trainPct').innerText = Math.round((1 - val) * 100);
                           ">
                </div>

                <button id="trainBtn" onclick="startTrain()">
                    <i class="fas fa-play"></i> Start Training
                </button>

                <div id="trainingStatus" class="status-box hidden">
                    <div class="spinner"></div>
                    <span id="statusText">Đang khởi tạo...</span>
                </div>
            </div>

            <!-- PREDICTION CARD -->
            <div class="card">
                <h3><i class="fas fa-cube"></i> Live Prediction</h3>
                <p>Run inference on a single data point.</p>
                
                <details style="margin-bottom: 1rem; color: var(--gray); font-size: 0.9rem;">
                    <summary style="cursor: pointer; font-weight: 500;">Feature Details</summary>
                    <p style="margin-top: 0.5rem; text-align: justify;">
                        <strong>Live Prediction</strong> provides an interface for real-time model inference.
                        Enter the four feature dimensions (sepal/petal length/width) to receive an instant classification.
                        The system returns the predicted class, a <strong>Confidence Score</strong>, and a full probability distribution.
                        Low-confidence predictions (< 70%) trigger an automatic warning to flag potential uncertainty.
                    </p>
                </details>

                <form action="/predict" method="post" id="predictForm">
                    <div class="input-group">
                        <label>Sepal Length</label>
                        <input type="number" step="0.1" name="sepal_length" required placeholder="5.1">
                    </div>
                    <div class="input-group">
                        <label>Sepal Width</label>
                        <input type="number" step="0.1" name="sepal_width" required placeholder="3.5">
                    </div>
                    <div class="input-group">
                        <label>Petal Length</label>
                        <input type="number" step="0.1" name="petal_length" required placeholder="1.4">
                    </div>
                    <div class="input-group">
                        <label>Petal Width</label>
                        <input type="number" step="0.1" name="petal_width" required placeholder="0.2">
                    </div>
                    <button type="submit" class="btn-predict">
                        <i class="fas fa-search"></i> Predict Class
                    </button>
                </form>

                {% if result and not csv_result %}
                <div class="result-box">
                    <h4>Prediction Result</h4>
                    
                    {% if result.warning %}
                    <div class="warning-box" style="background: #fffbeb; color: #92400e; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #fcd34d;">
                        <i class="fas fa-exclamation-triangle"></i> {{ result.warning }}
                    </div>
                    {% endif %}

                    <p class="class-label">{{ result.label }}</p>
                    <p class="confidence">Confidence: {{ (result.confidence * 100) | round(2) }}%</p>
                    
                    <div class="prob-container" style="margin-top: 1rem;">
                        {% for item in result.probs %}
                        <div class="prob-item" style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                <span>{{ item.name }}</span>
                                <span>{{ (item.prob * 100) | round(1) }}%</span>
                            </div>
                            <div class="prob-bar-bg" style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div class="prob-bar-fill" style="width: {{ item.prob * 100 }}%; background: var(--primary); height: 100%;"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if error %}
                <div class="error-box">
                    <i class="fas fa-exclamation-circle"></i> {{ error }}
                </div>
                {% endif %}
            </div>

            <!-- UPLOAD CARD -->
            <div class="card upload-card">
                <h3><i class="fas fa-file-csv"></i> Batch Analysis</h3>
                <p>Upload a CSV file to classification multiple samples at once.</p>
                <details style="margin-bottom: 1rem; color: var(--gray); font-size: 0.9rem;">
                    <summary style="cursor: pointer; font-weight: 500;">Feature Details</summary>
                    <p style="margin-top: 0.5rem; text-align: justify;">
                        <strong>Batch Analysis</strong> facilitates high-volume inference by processing CSV datasets.
                        It is essential for validating model performance against test sets or processing backlog data.
                        The system automatically generates comprehensive reports including <strong>Confusion Matrices</strong>, Accuracy metrics, and 2D/3D visualization of the decision boundaries and data distribution.
                    </p>
                </details>
                <form action="/predict_csv" method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="file-drop-area" id="dropZone">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <span class="file-msg">Drag & Drop or Click to Upload</span>
                        <input class="file-input" type="file" name="file" accept=".csv" required id="fileInput">
                    </div>
                    <button type="submit" class="btn-upload">
                        <i class="fas fa-chart-pie"></i> Analyze CSV
                    </button>
                </form>
            </div>
            
            <!-- HISTORY -->
            <div class="card full-width">
                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr><th>Time</th><th>Inputs</th><th>Prediction</th><th>Confidence</th></tr>
                        </thead>
                        <tbody>
                            {% for item in history %}
                            <tr {% if item.warning %}style="background: #fffbeb;"{% endif %}>
                                <td>{{ item.time }}</td>
                                <td>{{ item.input.sepal_length }}, {{ item.input.sepal_width }}...</td>
                                <td><span class="badge">{{ item.prediction }}</span></td>
                                <td>
                                    {{ (item.confidence * 100) | round(1) }}%
                                    {% if item.warning %}
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-left: 0.5rem;" title="Low Confidence"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" style="text-align: center;">No history.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BATCH RESULTS (Existing) -->
            {% if csv_result %}
            <div class="card full-width analysis-section">
                <h2><i class="fas fa-chart-line"></i> Batch Analysis Results</h2>
                
                <div class="metric-summary">
                    <strong>Accuracy: {{ metrics.accuracy }}</strong> | Samples: {{ metrics.total_samples }}
                </div>

                <div class="analysis-grid">
                    {% if metrics.has_labels %}
                    <div class="analysis-item">
                        <h3>Confusion Matrix</h3>
                        <img src="{{ url_for('static', filename='confusion_matrix.png') }}" >
                    </div>
                    {% endif %}
                    <div class="analysis-item">
                        <h3>2D Decision Boundary</h3>
                        <img src="{{ url_for('static', filename='scatter_2d.png') }}" >
                    </div>
                    <div class="analysis-item">
                        <h3>Class Accuracy</h3>
                        <img src="{{ url_for('static', filename='accuracy_bar.png') }}" >
                    </div>
                    <div class="analysis-item">
                        <h3>Training Loss Curve</h3>
                        <img src="{{ url_for('static', filename='loss_curve.png') }}" >
                    </div>
                    <div class="analysis-item">
                        <h3>Prediction Uncertainty</h3>
                        <img src="{{ url_for('static', filename='sample_loss.png') }}" >
                    </div>
                    <div class="analysis-item">
                        <h3>3D Feature Space</h3>
                        <img src="{{ url_for('static', filename='scatter_3d.png') }}" >
                    </div>
                </div>
                
                <div class="table-container" style="margin-top: 1rem;">
                    {{ table_html | safe }}
                </div>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- 2. MODEL VERSIONING TAB -->
    <div id="models" class="tab-pane">
        <div class="card full-width">
            <h3><i class="fas fa-server"></i> Model Registry</h3>
            <p>Manage trained model versions. Rollback to previous checkpoints instantly.</p>
            <div id="modelList">Loading...</div>
        </div>
    </div>

    <!-- 3. INSIGHTS TAB (Drift & XAI) -->
    <div id="insights" class="tab-pane">
        <div class="grid-layout">
            <!-- Feature Importance -->
            <div class="card full-width">
                <h3><i class="fas fa-search-dollar"></i> Feature Importance (XAI)</h3>
                <p>Understanding which features contribute most to the model's decisions (Mean |Coefficient|).</p>
                <div style="height: 300px;">
                    <canvas id="importanceChart"></canvas>
                </div>
            </div>

            <!-- Drift Detection -->
            <div class="card full-width">
                <h3><i class="fas fa-wind"></i> Data Drift Detection</h3>
                <p>Compare new data against the training baseline to detect distribution shifts.</p>
                
                <div style="margin-bottom: 1rem;">
                    <div class="file-drop-area" id="driftDropZone">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <span class="file-msg" id="driftFileMsg">Drag & Drop Drift Data CSV</span>
                        <input class="file-input" type="file" id="driftFile" accept=".csv">
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                    <div style="flex-grow: 1;"></div> 
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label style="font-weight: 500; color: var(--gray);">Threshold (%):</label>
                        <input type="number" id="driftThreshold" value="20" style="width: 80px; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    <button onclick="checkDrift()" class="btn-secondary">
                        <i class="fas fa-microscope"></i> Detect Drift
                    </button>
                </div>

                <div id="driftResult"></div>
            </div>
        </div>
    </div>

    <!-- 4. TRAINING LAB TAB -->
    <div id="lab" class="tab-pane">
        <div class="grid-layout">
            <div class="card">
                <h3><i class="fas fa-sliders-h"></i> Hyperparameter Tuning</h3>
                <p>Experiment with SGD parameters in a sandbox environment.</p>
                
                <div class="slider-container">
                    <label>Learning Rate (Alpha): <span id="valAlpha" style="font-weight:bold; color:var(--primary);">0.0001</span></label>
                    <input type="range" id="labAlpha" min="0.0001" max="0.1" step="0.0001" value="0.0001" class="range-slider">
                </div>
                
                <div class="slider-container">
                    <label>Epochs: <span id="valEpochs" style="font-weight:bold; color:var(--primary);">50</span></label>
                    <input type="range" id="labEpochs" min="10" max="200" step="10" value="50" class="range-slider">
                </div>

                <button class="btn-lab" onclick="runLab()">
                    <i class="fas fa-flask"></i> Run Experiment
                </button>

                <div class="lab-metrics">
                    <div>
                        <div style="font-size:0.8rem; color:var(--gray);">New Validation Acc</div>
                        <div class="metric-val" id="labNewAcc">--</div>
                    </div>
                    <div>
                        <div style="font-size:0.8rem; color:var(--gray);">Current Production Acc</div>
                        <div class="metric-val" id="labCurrAcc">--</div>
                    </div>
                </div>
                <div id="labResult"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-chart-area"></i> Real-time Loss Curve</h3>
                <canvas id="labChart"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
<script>
    // Keep keep-alive or minimal inline logic if needed, but mostly in dashboard.js
    // Re-implement startTrain/checkStatus because they were inline in the old file
    function startTrain() {
        const btn = document.getElementById("trainBtn");
        const statusBox = document.getElementById("trainingStatus");
        const statusText = document.getElementById("statusText");
        const testSize = document.getElementById("testSize").value;
    
        // Store original text in dataset if not already
        if(!btn.dataset.originalText) btn.dataset.originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training...';
        
        statusBox.classList.remove("hidden");
        statusText.textContent = "Initializing training...";
    
        fetch("/train", { 
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({test_size: testSize})
        })
            .then(r => r.json())
            .then(data => {
                if(data.status === "started" || data.status === "already running") {
                    checkStatus();
                } else {
                    alert("Error starting training: " + JSON.stringify(data));
                    btn.disabled = false;
                    btn.innerHTML = btn.dataset.originalText;
                    statusBox.classList.add("hidden");
                }
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = btn.dataset.originalText;
            });
    }
    
    function checkStatus() {
        const statusText = document.getElementById("statusText");
        const btn = document.getElementById("trainBtn");
        const statusBox = document.getElementById("trainingStatus");
    
        const interval = setInterval(() => {
            fetch("/train_status")
                .then(r => r.json())
                .then(s => {
                    if (s.running) {
                        statusText.innerText = `Training Epoch ${s.epoch} / ${s.total}`;
                    } else {
                        statusText.innerText = "Training Completed Successfully!";
                        btn.disabled = false;
                        if(btn.dataset.originalText) btn.innerHTML = btn.dataset.originalText;
                        clearInterval(interval);
                        setTimeout(() => {
                            statusBox.classList.add("hidden");
                            // Optional: Refresh model list if on that tab
                             if(document.querySelector('.tab-btn[data-target="models"]').classList.contains('active')) loadModels();
                        }, 2000);
                    }
                })
                .catch(err => console.error("Status check failed", err));
        }, 1000);
    }

    // === GLOBAL SPINNER LOGIC FOR FORMS ===
    document.addEventListener("DOMContentLoaded", function() {
        const forms = document.querySelectorAll("form");
        
        forms.forEach(form => {
            form.addEventListener("submit", function(e) {
                // If form is valid
                if(form.checkValidity()) {
                    const btn = form.querySelector("button[type='submit']");
                    if(btn) {
                        const originalText = btn.innerText;
                        btn.disabled = true;
                        btn.innerHTML = `<div class="spinner" style="width:1rem; height:1rem; border-width:2px; display:inline-block; vertical-align:middle; margin-right:0.5rem;"></div> ${originalText}`;
                        
                        // If it's the upload form (not AJAX but page load), the disabled button might not send value? 
                        // Actually standard submit happens BEFORE disable if we don't preventDefault.
                        // But if we let it run, chrome submits it.
                        // However, strictly speaking, disabling a button *can* prevent submit in some triggers.
                        // But since this is 'submit' event, the event is already fired.
                        
                        // NOTE: If using fetch/AJAX manually (like in labs), we handle spinner there.
                        // These forms in index.html use standard POST action, so page reload will happen.
                    }
                }
            });
        });

        // === SHOW TOAST ON PAGE LOAD IF RESULT EXISTS ===
        // We can check if specific result elements exist
        if(document.querySelector('.result-box')) {
            showToast("Prediction Completed Successfully!", "success");
        }
        if(document.querySelector('.analysis-section')) { // Class I added for CSV result
            showToast("Batch Analysis Completed!", "success");
        }
        if(document.querySelector('.error-box')) {
             const errText = document.querySelector('.error-box').innerText.trim();
             if(errText) showToast(errText, "error");
        }
    });
</script>

</body>
</html>
